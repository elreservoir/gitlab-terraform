stages:
  - validate
  - apply

variables:
  TF_ADDRESS: https://gitlab.elreservoir.com/api/v4/projects/${CI_PROJECT_ID}/terraform/state/default
  TF_USERNAME: gitlab-ci-token
  TF_PASSWORD: ${CI_JOB_TOKEN}

terraform-test:
  stage: validate
  image:
    name: ghcr.io/opentofu/opentofu:latest
    entrypoint: [""]
  script: |
    tofu init \
    -backend-config=address=${TF_ADDRESS} \
    -backend-config=lock_address=${TF_ADDRESS}/lock \
    -backend-config=unlock_address=${TF_ADDRESS}/lock \
    -backend-config=username=${TF_USERNAME} \
    -backend-config=password=${TF_PASSWORD} \
    -backend-config=lock_method=POST \
    -backend-config=unlock_method=DELETE \
    -backend-config=retry_wait_min=5
    tofu validate

terraform-plan-apply:
  stage: apply
  needs: ["terraform-test"]
  image:
    name: ghcr.io/opentofu/opentofu:latest
    entrypoint: [""]
  before_script:
  - export TF_VAR_VAULT_TOKEN=${VAULT_TOKEN}
  - export TF_VAR_VAULT_ADDRESS=${VAULT_ADDR}
  script: |
    tofu init \
    -backend-config=address=${TF_ADDRESS} \
    -backend-config=lock_address=${TF_ADDRESS}/lock \
    -backend-config=unlock_address=${TF_ADDRESS}/lock \
    -backend-config=username=${TF_USERNAME} \
    -backend-config=password=${TF_PASSWORD} \
    -backend-config=lock_method=POST \
    -backend-config=unlock_method=DELETE \
    -backend-config=retry_wait_min=5
    tofu plan -out=tfplan
    tofu apply -auto-approve tfplan